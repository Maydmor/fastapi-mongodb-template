<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>security.auth API documentation</title>
<meta name="description" content="Dependencies and helper functions related to security" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>security.auth</code></h1>
</header>
<section id="section-intro">
<p>Dependencies and helper functions related to security</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Dependencies and helper functions related to security&#34;&#34;&#34;
from datetime import datetime, timedelta
from fastapi import HTTPException, status, Depends
from fastapi.security import OAuth2PasswordBearer
from models.user import Admin, User, UserRole
from repositories.user import UserRepository
from jose import jwt, JWTError
from settings import AuthSettings
from functools import wraps

INVALID_CREDENTIAL_ERROR = HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=f&#39;Invalid username or password&#39;)
INVALID_TOKEN_ERROR = HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, 
    detail=f&#39;Invalid token, log in again&#39;, headers={&#34;WWW-Authenticate&#34;: &#34;Bearer&#34;})
INSUFFICIENT_PERMISSIONS_ERROR = HTTPException(status_code=status.HTTP_403_FORBIDDEN, 
    detail=f&#39;Your permissions are not sufficient&#39;)

oauth2_scheme = OAuth2PasswordBearer(tokenUrl=&#34;token&#34;)

async def auth_user(email: str, password: str)-&gt;User:
    &#34;&#34;&#34;Checks if the given user exists and the password matches with the database entry

    Args:
        email (str): provided email
        password (str): provided password

    Raises:
        INVALID_CREDENTIAL_ERROR: when the user was not found or the password was wrong

    Returns:
        User: The user in the database
    &#34;&#34;&#34;
    user = await UserRepository().get_user_by_email(email)
    if user is None:
        raise INVALID_CREDENTIAL_ERROR
    if not user.verify_password(password):
        raise INVALID_CREDENTIAL_ERROR
    return user

def create_access_token(data: dict, expires_delta: timedelta | None = None)-&gt;str:
    &#34;&#34;&#34;Creates a jwt token string

    Args:
        data (dict): The data to encode in the jwt
        expires_delta (timedelta | None, optional): timedelta when the token should expire. Defaults to None.

    Returns:
        str: The encoded jwt token string
    &#34;&#34;&#34;
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({&#34;exp&#34;: expire})
    encoded_jwt = jwt.encode(to_encode, AuthSettings().secret_key, algorithm=AuthSettings().jwt_algorithm)
    return encoded_jwt

class AuthRules:
    &#34;&#34;&#34;Class holding all auth rule dependencies&#34;&#34;&#34;
    async def require_user(token: str = Depends(oauth2_scheme))-&gt;User:
        &#34;&#34;&#34;Gets the user from the jwt token from the request

        Args:
            token (str, optional): The token. Defaults to Depends(oauth2_scheme).

        Raises:
            INVALID_TOKEN_ERROR: When the token is expired, invalid or the user from the token does not exist

        Returns:
            User: the owner of the token
        &#34;&#34;&#34;
        try:
            payload = jwt.decode(token, AuthSettings().secret_key, algorithms=[AuthSettings().jwt_algorithm])
            email = payload.get(&#39;sub&#39;)
            if email is None:
                raise INVALID_TOKEN_ERROR
        except JWTError as e:
            raise INVALID_TOKEN_ERROR
        user = await UserRepository().get_user_by_email(email)
        if user is None:
            raise INVALID_TOKEN_ERROR
        return user

    async def is_admin(user: User = Depends(require_user))-&gt;bool:
        &#34;&#34;&#34;checks if the current user has the admin role

        Args:
            user (User, optional): the user object to check. Defaults to Depends(require_user).

        Returns:
            bool: true if the user has the admin role
        &#34;&#34;&#34;
        return user.role == UserRole.admin

    async def require_admin(user: User = Depends(require_user), is_admin: bool = Depends(is_admin))-&gt;Admin:
        &#34;&#34;&#34;dependency returning the current user if it has the admin role. 

        Args:
            user (User, optional): the user object to check. Defaults to Depends(require_user).
            is_admin (bool, optional): a boolean indicating wheter the user is admin or not. Defaults to Depends(is_admin).

        Raises:
            INSUFFICIENT_PERMISSIONS_ERROR: when the user is not an admin

        Returns:
            Admin: the admin object
        &#34;&#34;&#34;
        if not is_admin:
            raise INSUFFICIENT_PERMISSIONS_ERROR
        return user</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="security.auth.auth_user"><code class="name flex">
<span>async def <span class="ident">auth_user</span></span>(<span>email: str, password: str) ‑> <a title="models.user.User" href="../models/user.html#models.user.User">User</a></span>
</code></dt>
<dd>
<div class="desc"><p>Checks if the given user exists and the password matches with the database entry</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>email</code></strong> :&ensp;<code>str</code></dt>
<dd>provided email</dd>
<dt><strong><code>password</code></strong> :&ensp;<code>str</code></dt>
<dd>provided password</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>INVALID_CREDENTIAL_ERROR</code></dt>
<dd>when the user was not found or the password was wrong</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>User</code></dt>
<dd>The user in the database</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def auth_user(email: str, password: str)-&gt;User:
    &#34;&#34;&#34;Checks if the given user exists and the password matches with the database entry

    Args:
        email (str): provided email
        password (str): provided password

    Raises:
        INVALID_CREDENTIAL_ERROR: when the user was not found or the password was wrong

    Returns:
        User: The user in the database
    &#34;&#34;&#34;
    user = await UserRepository().get_user_by_email(email)
    if user is None:
        raise INVALID_CREDENTIAL_ERROR
    if not user.verify_password(password):
        raise INVALID_CREDENTIAL_ERROR
    return user</code></pre>
</details>
</dd>
<dt id="security.auth.create_access_token"><code class="name flex">
<span>def <span class="ident">create_access_token</span></span>(<span>data: dict, expires_delta: datetime.timedelta | None = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a jwt token string</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>data</code></strong> :&ensp;<code>dict</code></dt>
<dd>The data to encode in the jwt</dd>
</dl>
<p>expires_delta (timedelta | None, optional): timedelta when the token should expire. Defaults to None.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>The encoded jwt token string</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_access_token(data: dict, expires_delta: timedelta | None = None)-&gt;str:
    &#34;&#34;&#34;Creates a jwt token string

    Args:
        data (dict): The data to encode in the jwt
        expires_delta (timedelta | None, optional): timedelta when the token should expire. Defaults to None.

    Returns:
        str: The encoded jwt token string
    &#34;&#34;&#34;
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({&#34;exp&#34;: expire})
    encoded_jwt = jwt.encode(to_encode, AuthSettings().secret_key, algorithm=AuthSettings().jwt_algorithm)
    return encoded_jwt</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="security.auth.AuthRules"><code class="flex name class">
<span>class <span class="ident">AuthRules</span></span>
</code></dt>
<dd>
<div class="desc"><p>Class holding all auth rule dependencies</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AuthRules:
    &#34;&#34;&#34;Class holding all auth rule dependencies&#34;&#34;&#34;
    async def require_user(token: str = Depends(oauth2_scheme))-&gt;User:
        &#34;&#34;&#34;Gets the user from the jwt token from the request

        Args:
            token (str, optional): The token. Defaults to Depends(oauth2_scheme).

        Raises:
            INVALID_TOKEN_ERROR: When the token is expired, invalid or the user from the token does not exist

        Returns:
            User: the owner of the token
        &#34;&#34;&#34;
        try:
            payload = jwt.decode(token, AuthSettings().secret_key, algorithms=[AuthSettings().jwt_algorithm])
            email = payload.get(&#39;sub&#39;)
            if email is None:
                raise INVALID_TOKEN_ERROR
        except JWTError as e:
            raise INVALID_TOKEN_ERROR
        user = await UserRepository().get_user_by_email(email)
        if user is None:
            raise INVALID_TOKEN_ERROR
        return user

    async def is_admin(user: User = Depends(require_user))-&gt;bool:
        &#34;&#34;&#34;checks if the current user has the admin role

        Args:
            user (User, optional): the user object to check. Defaults to Depends(require_user).

        Returns:
            bool: true if the user has the admin role
        &#34;&#34;&#34;
        return user.role == UserRole.admin

    async def require_admin(user: User = Depends(require_user), is_admin: bool = Depends(is_admin))-&gt;Admin:
        &#34;&#34;&#34;dependency returning the current user if it has the admin role. 

        Args:
            user (User, optional): the user object to check. Defaults to Depends(require_user).
            is_admin (bool, optional): a boolean indicating wheter the user is admin or not. Defaults to Depends(is_admin).

        Raises:
            INSUFFICIENT_PERMISSIONS_ERROR: when the user is not an admin

        Returns:
            Admin: the admin object
        &#34;&#34;&#34;
        if not is_admin:
            raise INSUFFICIENT_PERMISSIONS_ERROR
        return user</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="security.auth.AuthRules.is_admin"><code class="name flex">
<span>async def <span class="ident">is_admin</span></span>(<span>user: <a title="models.user.User" href="../models/user.html#models.user.User">User</a> = Depends(require_user)) ‑> bool</span>
</code></dt>
<dd>
<div class="desc"><p>checks if the current user has the admin role</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user</code></strong> :&ensp;<code>User</code>, optional</dt>
<dd>the user object to check. Defaults to Depends(require_user).</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>bool</code></dt>
<dd>true if the user has the admin role</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def is_admin(user: User = Depends(require_user))-&gt;bool:
    &#34;&#34;&#34;checks if the current user has the admin role

    Args:
        user (User, optional): the user object to check. Defaults to Depends(require_user).

    Returns:
        bool: true if the user has the admin role
    &#34;&#34;&#34;
    return user.role == UserRole.admin</code></pre>
</details>
</dd>
<dt id="security.auth.AuthRules.require_admin"><code class="name flex">
<span>async def <span class="ident">require_admin</span></span>(<span>user: <a title="models.user.User" href="../models/user.html#models.user.User">User</a> = Depends(require_user), is_admin: bool = Depends(is_admin)) ‑> <a title="models.user.Admin" href="../models/user.html#models.user.Admin">Admin</a></span>
</code></dt>
<dd>
<div class="desc"><p>dependency returning the current user if it has the admin role. </p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>user</code></strong> :&ensp;<code>User</code>, optional</dt>
<dd>the user object to check. Defaults to Depends(require_user).</dd>
<dt><strong><code>is_admin</code></strong> :&ensp;<code>bool</code>, optional</dt>
<dd>a boolean indicating wheter the user is admin or not. Defaults to Depends(is_admin).</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>INSUFFICIENT_PERMISSIONS_ERROR</code></dt>
<dd>when the user is not an admin</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Admin</code></dt>
<dd>the admin object</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def require_admin(user: User = Depends(require_user), is_admin: bool = Depends(is_admin))-&gt;Admin:
    &#34;&#34;&#34;dependency returning the current user if it has the admin role. 

    Args:
        user (User, optional): the user object to check. Defaults to Depends(require_user).
        is_admin (bool, optional): a boolean indicating wheter the user is admin or not. Defaults to Depends(is_admin).

    Raises:
        INSUFFICIENT_PERMISSIONS_ERROR: when the user is not an admin

    Returns:
        Admin: the admin object
    &#34;&#34;&#34;
    if not is_admin:
        raise INSUFFICIENT_PERMISSIONS_ERROR
    return user</code></pre>
</details>
</dd>
<dt id="security.auth.AuthRules.require_user"><code class="name flex">
<span>async def <span class="ident">require_user</span></span>(<span>token: str = Depends(OAuth2PasswordBearer)) ‑> <a title="models.user.User" href="../models/user.html#models.user.User">User</a></span>
</code></dt>
<dd>
<div class="desc"><p>Gets the user from the jwt token from the request</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>token</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>The token. Defaults to Depends(oauth2_scheme).</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>INVALID_TOKEN_ERROR</code></dt>
<dd>When the token is expired, invalid or the user from the token does not exist</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>User</code></dt>
<dd>the owner of the token</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def require_user(token: str = Depends(oauth2_scheme))-&gt;User:
    &#34;&#34;&#34;Gets the user from the jwt token from the request

    Args:
        token (str, optional): The token. Defaults to Depends(oauth2_scheme).

    Raises:
        INVALID_TOKEN_ERROR: When the token is expired, invalid or the user from the token does not exist

    Returns:
        User: the owner of the token
    &#34;&#34;&#34;
    try:
        payload = jwt.decode(token, AuthSettings().secret_key, algorithms=[AuthSettings().jwt_algorithm])
        email = payload.get(&#39;sub&#39;)
        if email is None:
            raise INVALID_TOKEN_ERROR
    except JWTError as e:
        raise INVALID_TOKEN_ERROR
    user = await UserRepository().get_user_by_email(email)
    if user is None:
        raise INVALID_TOKEN_ERROR
    return user</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="security" href="index.html">security</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="security.auth.auth_user" href="#security.auth.auth_user">auth_user</a></code></li>
<li><code><a title="security.auth.create_access_token" href="#security.auth.create_access_token">create_access_token</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="security.auth.AuthRules" href="#security.auth.AuthRules">AuthRules</a></code></h4>
<ul class="">
<li><code><a title="security.auth.AuthRules.is_admin" href="#security.auth.AuthRules.is_admin">is_admin</a></code></li>
<li><code><a title="security.auth.AuthRules.require_admin" href="#security.auth.AuthRules.require_admin">require_admin</a></code></li>
<li><code><a title="security.auth.AuthRules.require_user" href="#security.auth.AuthRules.require_user">require_user</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>